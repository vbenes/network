# SPDX-License-Identifier: BSD-3-Clause
---
- hosts: all
  vars:
    master_profile: bond0
    master_device: nm-bond
    slave1_profile: bond0.0
    slave1_device: test1
    slave2_profile: bond0.1
    slave2_device: test2
  tasks:
    - name: "INIT Prepare setup"
      debug:
        msg: "##################################################"
    - include_tasks: tasks/create_test_interfaces_with_dhcp.yml
    - include_tasks: tasks/assert_device_present.yml
      vars:
        interface: "{{ slave1_device }}"
    - include_tasks: tasks/assert_device_present.yml
      vars:
        interface: "{{ slave2_device }}"
    - block:
        - name: "TEST Add Bond with 2 slaves"
          debug:
            msg: "##################################################"
        - import_role:
            name: linux-system-roles.network
          vars:
            network_connections:
              # Create a bond master
              - name: "{{ master_profile }}"
                state: up
                type: bond
                interface_name: "{{ master_device }}"
                bond:
                  mode: active-backup
                  miimon: 110
              # enslave an ethernet to the bond
              - name: "{{ slave1_profile }}"
                state: up
                type: ethernet
                interface_name: "{{ slave1_device }}"
                master: "{{ master_profile }}"
              # enslave a second ethernet to the bond
              - name: "{{ slave2_profile }}"
                state: up
                type: ethernet
                interface_name: "{{ slave2_device }}"
                master: "{{ master_profile }}"
        - include_tasks: tasks/assert_device_present.yml
          vars:
            interface: "{{ master_device }}"
        - include_tasks: tasks/assert_profile_present.yml
          vars:
            profile: "{{ item }}"
          loop:
            - "{{ master_profile }}"
            - "{{ slave1_profile }}"
            - "{{ slave2_profile }}"

      always:
        - block:
            - import_role:
                name: linux-system-roles.network
              vars:
                network_connections:
                  - name: "{{ slave2_profile }}"
                    persistent_state: absent
                    state: down
                  - name: "{{ slave1_profile }}"
                    persistent_state: absent
                    state: down
                  - name: "{{ master_profile }}"
                    persistent_state: absent
                    state: down

              ignore_errors: true
            - include_tasks: tasks/remove_test_interfaces_with_dhcp.yml
          tags:
            - "tests::cleanup"
